<!DOCTYPE html>
<html>

<head>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <!-- default header name is X-CSRF-TOKEN -->
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  <script>
    var zones;
    var zoneIndex;

    function initialize()
    {
      $('#zoneEditTermination').val('TIMER');
      $('#zoneEditPower').change(handlePower);
      $('#zoneEditTermination').change(handleTermination);
      $('#zoneEditExecute').click(editZoneExecute);
      test();
//      loadInfo();
    }

    function handlePower()
    {
      power=$('#zoneEditPower').val();
      if (power=='ON')
      {
        $('#zoneEditTemperature').prop( "disabled", false );
        $('#zoneEditTermination').prop( "disabled", false );
        handleTermination();
      }
      else
      {
        $('#zoneEditTemperature').prop( "disabled", true );
        $('#zoneEditTermination').prop( "disabled", true );
        $('#zoneEditTimer').prop( "disabled", true );
      }
    }

    function handleTermination()
    {
      term=$('#zoneEditTermination').val();
      if (term=='TIMER')
      {
        $('#zoneEditTimer').prop( "disabled", false );
      }
      else 
      {
        $('#zoneEditTimer').prop( "disabled", true );
      }
    }

    function test()
    {
      zones=[{name: "TestZone", 
              id: 1,
              power: "ON",
              temperature: 20.15,
              temperatureSetpoint: 23,
              temperaturePrecision: 1.0,
              termination: 'INFINITE',
              timer: 1860}];
      editZone(0);
    }
    
    function display(response)
    {
      var html;
      var i;

      zones=response;

      html = '<table class="table">';
      html += '<tr>';
      html += '<td>Name</td>';
      html += '<td>Type</td>';
      html += '<td>Power</td>';
      html += '<td>Temperature</td>';
      html += '<td>Temperature Setpoint</td>';
      html += '<td>Humidity</td>';
      html += '<td>Presence</td>';
      html += '</tr>';
      for (i = 0; i < response.length; i++)
      {
        html += '<tr>';
        html += '<td>' + response[i].name + '</td>';
        html += '<td>' + response[i].type + '</td>';
        html += '<td>' + response[i].power + '</td>';
        if (response[i].temperature != null)
        {
          html += '<td>' + response[i].temperature + ' °C</td>';
        }
        else
        {
          html += '<td></td>';
        }
        if (response[i].temperatureSetpoint != null)
        {
          html += '<td>' + response[i].temperatureSetpoint + ' °C</td>';
        }
        else
        {
          html += '<td></td>';
        }
        if (response[i].humidity != null)
        {
          html += '<td>' + response[i].humidity + ' %</td>';
        }
        else
        {
          html += '<td></td>';
        }
        html += '<td>' + response[i].tadoMode + '</td>';
        html += '<td><a href="javascript:editZone(' + i + ')" role="button" class="btn btn-primary btn-block"><i class="fas fa-edit"></i> Edit</a></td>';
        html += '</tr>';
      }
      //document.getElementById("info").innerHTML = html;
      $('#info').html(html);
    }

    function editZone(zoneIndex)
    {
      $('#zoneEditTitle').html("Edit zone "+zones[zoneIndex].name);
      $('#zoneEditTemperature').val(zones[zoneIndex].temperatureSetpoint);
      $('#zoneEditTermination').val(zones[zoneIndex].termination);
      $('#zoneEditTimer').val(zones[zoneIndex].timer/60);
      $('#zoneEditTemperature').attr('step', zones[zoneIndex].temperaturePrecision);

      $('#zoneEditModal').modal("show");
    }

    function editZoneExecute()
    {
      alert('Go');
    }

    function loadInfo()
    {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function ()
      {
        if (this.readyState == 4 && this.status == 200)
        {
          display(JSON.parse(this.responseText));
        }
      };
      xhttp.open("GET", "/api/zones", true);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send("");
    }

    function setPresence(presence)
    {
      var xhttp = new XMLHttpRequest();
      var header = document.querySelector("[name='_csrf_header'][content]").content
      var headerValue = document.querySelector("[name='_csrf'][content]").content

      xhttp.onreadystatechange = function ()
      {
        if (this.readyState == 4 && this.status == 200)
        {
          loadInfo();
        }
      };
      xhttp.open("PUT", "/api/presence", true);
      xhttp.setRequestHeader("Content-type", "text/plain");
      xhttp.setRequestHeader(header, headerValue);
      xhttp.send(presence);
    }
  </script>
</head>

<body onload="javascript:initialize();">
  <div class="container-fluid">
    <div class="card">
      <div class="card-header">
        <h1>Zone info</h1>
      </div>
      <div class="card-body">
        <div id="info"></div>
      </div>
    </div>
  </div>
  <br>
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-2">
        <a href="javascript:setPresence('HOME')" role="button" class="btn btn-primary btn-block">
          <i class="fas fa-home"></i> Home
        </a>
      </div>
      <div class="col-sm-2">
        <a href="javascript:setPresence('AWAY')" role="button" class="btn btn-primary btn-block">
          <i class="fas fa-sign-out-alt"></i> Away
        </a>
      </div>
      <div class="col-sm-2">
        <a href="/" role="button" class="btn btn-primary btn-block">
          <i class="fas fa-backward"></i> Return
        </a>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="zoneEditModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 id="zoneEditTitle" class="modal-title"></h4>
          <button type="button" class="close" data-dismiss="modal"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
              <label for="zoneEditPower">Zone</label>
            <select class="form-control" id="zoneEditPower">
              <option value="ON">On</option>
              <option value="OFF">Off</option>
            </select>
          </div>

          <div class="form-group">
            <label for="zoneEditTemperature">Temperature</label>
            <input type="number" class="form-control" id="zoneEditTemperature" value="20.1" step="0.1">
          </div> 

          <div class="form-group">
            <label for="zoneEditTermination">Termination</label>
            <select class="form-control" id="zoneEditTermination">
              <option value="INFINITE">Manual</option>
              <option value="NEXTTIMEBLOCK">Till next time block</option>
              <option value="TIMER">Timer</option>
            </select>
          </div>

          <div class="form-group">
            <label for="zoneEditTimer">Timer (minutes)</label>
            <input type="number" class="form-control" id="zoneEditTimer" value="30" step="1">
          </div> 

          <button id="zoneEditExecute" type="submit" class="form-control btn btn-primary">Execute</button>

          <div id="zoneEditModalError" style="width:100%; height:100%; display:none; ">
            <h3>Error</h3>
            Sorry there was an error processing your form.
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>